<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://vdo3.freckled.ai/IOAC_Assets/ioc/support_Files/confetti.js"></script>
    <script src="https://vdo3.freckled.ai/IOAC_Assets/ioc/support_Files/konva.js"></script>
    <script src="https://vdo3.freckled.ai/IOAC_Assets/ioc/support_Files/commonFunction.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #ffffff;
        }

        @font-face {
            font-family: "Comic Neue";
            font-style: normal;
            font-weight: 400;
            src: url(https://fonts.gstatic.com/s/comicneue/v8/4UaHrEJDsxBrF37olUeD96rp5w.woff2) format("woff2");
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6,
                U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC,
                U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
    </style>
</head>

<body>

    <body onload="loadData()">
        <div id="container"></div>
        <script>
            var stage = new Konva.Stage({
                container: "container",
                width: window.innerWidth,
                height: window.innerHeight
            });
            var layer = new Konva.Layer();
            stage.add(layer);
            var layer1 = new Konva.Layer();
            stage.add(layer1);
            var layer2 = new Konva.Layer();
            stage.add(layer2);
            var layer3 = new Konva.Layer();
            stage.add(layer3);
            var bgImg;
            var playbtn;
            var gamestartPanel;
            var playbutton;
            var aud, audios, audios1, audios2;
            var statuscount, sceneCount, sceneAudio, audios, quesTextaud;
            var textAud, text,next;
            var audiobar;
            var count = 0;
            function loadData() {
                window.addEventListener('message', handleMessage)
            }
            function handleMessage(event) {
                gameObj = event.data;
                score = gameObj.totalScore;
                stage.width(gameObj.stageWidth);
                stage.height(gameObj.stageHeight);
                if (gameObj.recordingPath && gameObj.recordingPath !== undefined) {
                    const objAssetId = gameObj.assetList.find((ele) => ele.className === "AnimationActivityProbAudio");
                    Object.assign(gameObj.gameData.question.text, { ...gameObj.gameData.question.text, audioPath: gameObj.recordingPath, recordingId: gameObj.recordingId });
                    delete gameObj.recordingPath;
                    delete gameObj.recordingId;
                    delete gameObj.assetId;
                }
                if (gameObj.operation === "Load Data") {
                    start();
                } else if (gameObj.operation === "GameStart") {
                    var startImg = startImage();
                    layer.add(startImg);
                    startImg.on("click tap", () => {
                        startImg.remove();
                        Object.assign(gameObj, { operation: "GameStart", gameStart: true });
                        window.parent.postMessage({ dataObj: gameObj }, "*");
                        start();
                    });
                }
            }
            function start() {
                statuscount = gameObj.gameData.statusCount;
                quesTextaud = audioHandler(gameObj.gameData.question.text.src);

                bgImg = bgImageLoader(gameObj.gameData.bgImage.image, 0);
                layer.add(bgImg);
                if (statuscount == 0) {
                    gameObj.gameData.gameStartPanel.map((d) => {
                        if (d.image) {
                            var gamestart = imageHandler(d.image, 0);
                            layer1.add(gamestart);
                        } else if (d.text) {
                            text = textHandler(d.text);
                            layer1.add(text);
                            textAud = audioHandler(d.text.src);
                            textAud.play();
                        }
                    })
                    playbutton = imageHandler(gameObj.gameData.playBtn.image, 0);
                    layer1.add(playbutton);
                    playbutton.on('click tap', () => {
                        textAud.volume = 0;
                        Object.assign(gameObj.gameData, { statusCount: 1 })
                        gamePlay();
                    })
                } else if (statuscount == 1) {
                    gamePlay();
                } else {
                    endGame();
                }
            }
            var arr = [];

            function gamePlay() {
                layer2.destroyChildren()
                arr = [];
                var tickpos = [1, 0, 3, 2, 4, 5, 6, 7, 8, 9];
                layer1.hide();
                gameObj.gameData.gameplay.map((d) => {
                    if (d.image) {
                        var start = imageHandler(d.image, 0);
                        layer2.add(start);
                    }
                })

                var finish = imageHandler(gameObj.gameData.finishBtn.image, 0);
                layer2.add(finish);
                finish.hide();
                finish.on("click tap", () => {
                    quesTextaud.volume = 0;
                    layer2.destroyChildren();
                    Object.assign(gameObj.gameData, { statusCount: 2 })
                    endGame();
                })

                var quesText = textHandler(gameObj.gameData.question.text);
                layer2.add(quesText);
                quesTextaud.play();
                for (var a = 0; a < gameObj.gameData.roundImg.image.positionList.length - 1; a++) {
                    roundbg = imageHandler(gameObj.gameData.roundImg.image, a);
                    layer2.add(roundbg);
                    arr.push(roundbg);
                }

                sceneCount = gameObj.gameData.sceneCount;
                sceneAudio = gameObj.gameData.sceneAudio;
                console.log(sceneCount - 1, sceneCount);

                for (var a = 1; a <= sceneCount - 1; a++) {
                    console.log(a)
                    console.log(gameObj.gameData[`scene${a}`])
                    gameObj.gameData[`scene${a}`].map((i) => {
                        console.log(i.image.isAns, i.image.pos)
                        if (i.image.isAns && i.image.pos != undefined) {
                            console.log("hgaufsjkaefga")
                            var img = imageHandler(i.image, 0)
                            layer2.add(img);
                            arr.map((o, k) => {
                                if (k === i.image.pos) {
                                    img.x(o.x());
                                    img.y(o.y());
                                    img.width(o.width());
                                    img.height(o.height());
                                    console.log(k)
                                    var tick = imageHandler(gameObj.gameData.tickImg.image, tickpos[k]);
                                    layer2.add(tick);
                                }
                            })
                        }
                    })
                }
                var dragCount = 0;
                if (sceneCount < 7) {
                    gameObj.gameData[`scene${sceneCount}`].map((d, ind) => {

                        if (d.image.status === true) {
                            console.log("llllll");
                            console.log("hgaufsjkaefga")
                            var img = imageHandler(d.image, 0)
                            layer2.add(img);
                            arr.map((o, k) => {
                                if (k === d.image.pos) {
                                    img.x(o.x());
                                    img.y(o.y());
                                    img.width(o.width());
                                    img.height(o.height());
                                    console.log(k)
                                    var tick = imageHandler(gameObj.gameData.tickImg.image, tickpos[k]);
                                    layer2.add(tick);
                                    nextFun();
                                }
                            })
                        } else {
                            var sceneImgs = imageHandler(d.image, 0);
                            layer2.add(sceneImgs);
                            quesTextaud.addEventListener("ended", () => {
                                //if (count === 0) {
                                //gameObj.gameData[`sceneaud${sceneAudio}`].map((d, i) => {
                                sceneImgs.on("mouseover tap", () => {
                                    if (ind === 0) {
                                        audios = audioHandler(gameObj.gameData[`sceneaud${sceneAudio}`][ind].text.src, 0);
                                        audios.play();
                                    }
                                    else if (ind === 1) {
                                        audios1 = audioHandler(gameObj.gameData[`sceneaud${sceneAudio}`][ind].text.src, 1);
                                        audios1.play();
                                    } else {
                                        audios2 = audioHandler(gameObj.gameData[`sceneaud${sceneAudio}`][ind].text.src, 2);
                                        audios2.play();
                                    }
                                })
                            })
                            sceneImgs.draggable(true);

                            sceneImgs.on("dragstart", () => {

                                if (d.image.isAns) {
                                    var dragwh = computeDimension(d.image.positionList[1].width, d.image.positionList[1].height);
                                    sceneImgs.width(dragwh[0]);
                                    sceneImgs.height(dragwh[1]);
                                } else {
                                    var wrong = computeDimension(85, 85);
                                    sceneImgs.width(wrong[0]);
                                    sceneImgs.height(wrong[1]);
                                }
                            })
                            sceneImgs.on("dragend", () => {
                                console.log(d.image.status === true);

                                //    else {
                                console.log(arr.length)
                                if (d.image.isAns) {
                                    arr.map((p, m) => {
                                        if (sceneImgs.x() > p.x() - 20 && sceneImgs.x() < p.x() + 20 &&
                                            sceneImgs.y() > p.y() - 20 && sceneImgs.y() < p.y() + 20
                                        ) {
                                            sceneImgs.x(p.x());
                                            sceneImgs.y(p.y());
                                            nextFun();

                                            console.log("mmmmmmmmmmmmmmmmmmmmmmmmmmmm", m)
                                            var tick = imageHandler(gameObj.gameData.tickImg.image, tickpos[m]);
                                            layer2.add(tick);
                                            Object.assign(gameObj.gameData[`scene${sceneCount}`][ind].image, { status: true })
                                            Object.assign(gameObj.gameData[`scene${sceneCount}`][ind].image, { pos: m })
                                            sceneImgs.draggable(false);
                                            dragCount++;

                                        }


                                        p.on("click", () => {
                                            console.log("gughuy");
                                        })
                                    })


                                }
                                else {
                                    var dragxy = computeDimension(d.image.positionList[0].x, d.image.positionList[0].y);
                                    sceneImgs.x(dragxy[0]);
                                    sceneImgs.y(dragxy[1]);
                                    var dragwh = computeDimension(d.image.positionList[0].width, d.image.positionList[0].height);
                                    sceneImgs.width(dragwh[0]);
                                    sceneImgs.height(dragwh[1]);
                                    dragCount++;
                                }
                                if (sceneCount == 6) {
                                    next.hide();
                                    finish.show();
                                }
                                //  }
                            })
                        }
                    });
                }

            }
            function nextFun() {
                next = imageHandler(gameObj.gameData.nextBtn.image, 0);

                layer2.add(next);
                // next.hide();
                next.on("click tap", () => {
                    quesTextaud.volume = 0;
                    sceneCount++;
                    sceneAudio++;
                    Object.assign(gameObj.gameData, { sceneCount: sceneCount })
                    Object.assign(gameObj.gameData, { sceneAudio: sceneAudio })
                    next.hide();
                    gamePlay();

                })
            }
            function endGame() {
                layer2.destroyChildren();

                console.log(gameObj)
                Object.assign(gameObj.gameData, { gameCompleted: true });
                Object.assign(gameObj, { totalScore: 100 })
                gameObj.gameData.gameEndPanel.map((d) => {
                    if (d.image) {
                        var endimg = imageHandler(d.image, 0);

                        layer2.add(endimg);
                    }
                    else if (d.text) {
                        audText = textHandler(d.text);
                        layer2.add(audText);
                        aud = audioHandler(d.text.src);
                        aud.play();
                    }
                });
            }
            function imageHandler(data, i) {
                var img = new Image();
                img.src = data.src;
                var wh = computeDimension(data.positionList[i].width, data.positionList[i].height);
                var xy = computeDimension(data.positionList[i].x, data.positionList[i].y);
                var image = new Konva.Image({
                    image: img,
                    width: wh[0],
                    height: wh[1],
                    x: xy[0],
                    text: data.text,
                    y: xy[1]
                });
                return image;
            }
            function textHandler(txt) {
                var wh = computeDimension(txt.positionList[0].width, txt.positionList[0].height);
                var xy = computeDimension(txt.positionList[0].x, txt.positionList[0].y);
                var fSize = computeDimension(txt.fontSize, 0);

                var text = new Konva.Text({
                    text: txt.text,
                    x: xy[0],
                    y: xy[1],
                    width: wh[0],
                    height: wh[1],
                    fontSize: fSize[0],
                    align: txt.textAlign,
                    fill: txt.fill,
                    fontFamily: txt.fontFamily,
                    fontStyle: txt.fontWeight,
                });
                return text;
            }
            function audioHandler(src, i) {
                var audio = document.createElement("audio");
                audio.src = src;
                return audio;
            }
        </script>
    </body>

</html>
